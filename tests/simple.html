<html> 

  <head>

        <title>dcpp.js| DC++ on Browser </title>
        <script src="include/util.js"></script>
        <script src="include/base64.js"></script>
        <script src="include/websock.js"></script> 
    </head>

    <body>
        WebSocket/websockify URI: <input id='target'>&nbsp;
        <input id='connectButton' type='button' value='Connect'
            onclick="connect();">
            <br/><br/>
            fdssssssssssssssss        <input id="getlock" type="text">&nbsp;
        <input type="button" value="Get Lock" onClick="calllock();">

        <br> <br>
        <input id='sendText'>&nbsp;
        <input id='sendButton' type='button' value='Send' disabled
            onclick="send();">&nbsp;
        <br> <br>
        
        
        Log:<br><textarea id="messages" cols=80 rows=25></textarea>
    </body>


    <script>
		// Coded by Mardeg
		function sendlock(key){
			ws.send_string("$Key "+key+"|");
			
		}
		function calllock(){
			
			lock2key(document.getElementById("getlock").value);
		}
function nibbleswap(bits) {
	return ((bits << 4) & 240) | ((bits >>> 4) & 15);
}
function chr(b) {
	return (("..0.5.36.96.124.126.").indexOf("."+b+".")>0)?"/%DCN"+(0).toPrecision(4-b.toString().length).substr(2)+b+"%/":String.fromCharCode(b);
}
function lock2key(lock) {
	var key = chr(nibbleswap(lock.charCodeAt(0) ^ lock.charCodeAt(-1) ^ lock.charCodeAt(-2) ^ 5));
	for (var i=1; i<lock.length; i++) {
		key += chr(nibbleswap(lock.charCodeAt(i) ^ lock.charCodeAt(i - 1)));
	}
	return key;
}


        var $D = function(id) { return document.getElementById(id); },
            ws = null, msgs = $D('messages');

        function msg(str) {
            msgs.innerHTML += str + "\n";
            msgs.scrollTop = msgs.scrollHeight;
        }

        function connect() {
            var uri = $D('target').value;
            ws = new Websock()
            msg("connecting to: " + uri);
            ws.open(uri);
            ws.on('open', function () {
                msg("Connected");
            });
            ws.on('message', function () {
				//alert("here");
				var response = ws.rQshiftStr();
				alert(response);
				//alert(response);
								var responseContainsConnect = response.search("Pk=");
								if (responseContainsConnect>=0){
								lock = response.slice(6,responseContainsConnect);
								key = lock2key(lock);
								sendlock(key);}

                msg("Received: " + response);
            });
            ws.on('close', function () {
                disconnect();
                msg("Disconnected");
            });

            $D('connectButton').value = "Disconnect";
            $D('connectButton').onclick = disconnect;
            $D('sendButton').disabled = false;
        }

        function disconnect() {
            if (ws) { ws.close(); }
            ws = null;

            $D('connectButton').value = "Connect";
            $D('connectButton').onclick = connect;
            $D('sendButton').disabled = true;
        }

        function send() {
            msg("Sending: " + $D('sendText').value);
            ws.send_string($D('sendText').value);
        };
    </script>

</html>
